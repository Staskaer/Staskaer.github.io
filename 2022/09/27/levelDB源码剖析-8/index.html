<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/imgs/theme_pic/staskaer.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/imgs/theme_pic/staskaer.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/imgs/theme_pic/staskaer.png">
  <link rel="mask-icon" href="/imgs/theme_pic/staskaer.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Block和SSTable的构建">
<meta property="og:type" content="article">
<meta property="og:title" content="levelDB源码剖析(8)--Block和SSTable的构建">
<meta property="og:url" content="http://example.com/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/index.html">
<meta property="og:site_name" content="Staskaer">
<meta property="og:description" content="Block和SSTable的构建">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/pic1.jpg">
<meta property="og:image" content="http://example.com/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/pic2.jpg">
<meta property="article:published_time" content="2022-09-27T12:34:08.000Z">
<meta property="article:modified_time" content="2022-11-04T06:02:40.759Z">
<meta property="article:author" content="Staskaer">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="levelDB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/pic1.jpg">

<link rel="canonical" href="http://example.com/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>levelDB源码剖析(8)--Block和SSTable的构建 | Staskaer</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Staskaer</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Hi, this is Staskaer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/imgs/theme_pic/head_img.png">
      <meta itemprop="name" content="Staskaer">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Staskaer">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          levelDB源码剖析(8)--Block和SSTable的构建
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-27 20:34:08" itemprop="dateCreated datePublished" datetime="2022-09-27T20:34:08+08:00">2022-09-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-04 14:02:40" itemprop="dateModified" datetime="2022-11-04T14:02:40+08:00">2022-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">levelDB源码剖析</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="block和sstable的构建">Block和SSTable的构建</h2>
<span id="more"></span>
<p>我们在之前提到了SSTable和内部的各类Block的结构，也初步分析了其在源码中的类级别的组织结构，但是我们也能注意到类结构和实际写入文件的结构是存在明显差异的，所以我们现在就需要进一步了解levelDB是如何构建这些Block与SSTable的。</p>
<div class="note primary">
            <p>源码位置与说明:</p><p>table/block_builder.cc table/block_builder.h : Block构建相关<br>include/leveldb/table_builder.h table/table_builder.cc :table构建相关<br>include/leveldb/table.h table/table.cc :读取一个Table的内容，产生迭代器，或者根据一个键读取一个值</p>
          </div>
<h3 id="block的构建--blockbuilder">Block的构建--BlockBuilder</h3>
<p>我们之前看到的Block的类其实只有存储的数据类型、迭代器和查询相关的东西，那么Block获取到的数据是哪里来的呢？也就是哪个类来负责把一个一个kv插入到data_中呢？其实这个类就是BlockBuilder。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token keyword">class</span> <span class="token class-name">BlockBuilder</span>
<span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">const</span> Options <span class="token operator">*</span>options_<span class="token punctuation">;</span>         <span class="token comment">// Options选项</span>
    std<span class="token double-colon punctuation">::</span>string buffer_<span class="token punctuation">;</span>             <span class="token comment">// 缓冲区，是存放kv的位置</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">&gt;</span> restarts_<span class="token punctuation">;</span> <span class="token comment">// Restart points</span>
    <span class="token keyword">int</span> counter_<span class="token punctuation">;</span>                    <span class="token comment">// 将此类重启后的元素数目</span>
    <span class="token keyword">bool</span> finished_<span class="token punctuation">;</span>                  <span class="token comment">// 是否构建完成</span>
    std<span class="token double-colon punctuation">::</span>string last_key_<span class="token punctuation">;</span>           <span class="token comment">//上一个key</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 构造析构函数相关</span>
    <span class="token keyword">explicit</span> <span class="token function">BlockBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">BlockBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> BlockBuilder <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    BlockBuilder <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> BlockBuilder <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

    <span class="token comment">// 重启此类，其实就是开启新的构建，因为每个Block内的数据大小是有限制的</span>
    <span class="token comment">// 但是不需要为每个Block都创建一个BlockBuilder</span>
    <span class="token keyword">void</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 把key-value加入，要求构建过程没有结束且key比之前加入的key要大</span>
    <span class="token keyword">void</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 结束此次构建，返回一个构建结果，即data_，包含数据区和偏执区两部分</span>
    <span class="token comment">// 返回的字符串一直到下次Finish()被调用前都有效</span>
    Slice <span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回构建的Block大小</span>
    size_t <span class="token function">CurrentSizeEstimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前构建是否为空</span>
    <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> buffer_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到一个BlockBuilder的作用其实就是不断把key-value添加到缓冲区中，然后在完成构建时返回这个缓冲区。由于没有必须要为每个Block都生成一个BlockBuilder类，所以BlockBuilder类是可以复用的。</p>
<p>下面我们来看一下具体的实现。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token class-name">BlockBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">BlockBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">*</span>options<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">options_</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">restarts_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">counter_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">finished_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>options<span class="token operator">-&gt;</span>block_restart_interval <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restarts_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一个重启点就是0偏置位置</span>
<span class="token punctuation">}</span>

<span class="token comment">// 重启BlockBuilder类</span>
<span class="token keyword">void</span> <span class="token class-name">BlockBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    buffer_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restarts_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restarts_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一个重启点就是0偏置位置</span>
    counter_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    finished_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    last_key_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回当前的构建大小，包含三部分组成：data_[] restart_[] restart_num</span>
size_t <span class="token class-name">BlockBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">CurrentSizeEstimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>buffer_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>                      <span class="token comment">// Raw data buffer</span>
            restarts_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token comment">// Restart array</span>
            <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// Restart array length</span>
<span class="token punctuation">}</span>

<span class="token comment">// 结束当次构建</span>
Slice <span class="token class-name">BlockBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 需要把所有的重启点插入到数据后面</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> restarts_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">PutFixed32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_<span class="token punctuation">,</span> restarts_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">PutFixed32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_<span class="token punctuation">,</span> restarts_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    finished_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Slice</span><span class="token punctuation">(</span>buffer_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插入key-value</span>
<span class="token keyword">void</span> <span class="token class-name">BlockBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Slice <span class="token function">last_key_piece</span><span class="token punctuation">(</span>last_key_<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取上一个key，需要保证当前key大于上一个key</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>finished_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>counter_ <span class="token operator">&lt;=</span> options_<span class="token operator">-&gt;</span>block_restart_interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>buffer_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// No values yet?</span>
           <span class="token operator">||</span> options_<span class="token operator">-&gt;</span>comparator<span class="token operator">-&gt;</span><span class="token function">Compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> last_key_piece<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t shared <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算出与上一个key之间的前缀长度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter_ <span class="token operator">&lt;</span> options_<span class="token operator">-&gt;</span>block_restart_interval<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// See how much sharing to do with previous string</span>
        <span class="token keyword">const</span> size_t min_length <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>last_key_piece<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>shared <span class="token operator">&lt;</span> min_length<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>last_key_piece<span class="token punctuation">[</span>shared<span class="token punctuation">]</span> <span class="token operator">==</span> key<span class="token punctuation">[</span>shared<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            shared<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 如果某个重启点后共享key数目到达预定值就新建重启点</span>
        restarts_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>buffer_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counter_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> size_t non_shared <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> shared<span class="token punctuation">;</span> <span class="token comment">// 非共享key长度</span>

    <span class="token comment">// 下面就是按照key的格式插入到data_中</span>
    <span class="token comment">// Add "&lt;shared&gt;&lt;non_shared&gt;&lt;value_size&gt;" to buffer_</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_<span class="token punctuation">,</span> shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PutVarint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add string delta to buffer_ followed by value</span>
    buffer_<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> shared<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer_<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新类内数据</span>
    last_key_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    last_key_<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> shared<span class="token punctuation">,</span> non_shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span>last_key_<span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    counter_<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到，BlockBuilder还是很简单的，主要就是创建重启点、插入key-value，不过需要注意的是这个插入key-value的时候需要保证keys是有序的。</p>
<h3 id="table类">Table类</h3>
<p>在之前我们讲述SSTable的时候，我们其实是没有提到Table这个类的，因为前面的内容有点多，下面我们就来具体看一下这个类。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token keyword">class</span> <span class="token class-name">LEVELDB_EXPORT</span> Table
<span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">TableCache</span><span class="token punctuation">;</span> <span class="token comment">// 友元缓存类</span>
    <span class="token keyword">struct</span> <span class="token class-name">Rep</span><span class="token punctuation">;</span>              <span class="token comment">// 这个是一个结构体，存放xxxhandler、Block之类的</span>

    <span class="token comment">// 把xxxindex Block中的内容给提取出来</span>
    <span class="token keyword">static</span> Iterator <span class="token operator">*</span><span class="token function">BlockReader</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> ReadOptions <span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭构造函数</span>
    <span class="token keyword">explicit</span> <span class="token function">Table</span><span class="token punctuation">(</span>Rep <span class="token operator">*</span>rep<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">rep_</span><span class="token punctuation">(</span>rep<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// Calls (*handle_result)(arg, ...) with the entry found after a call</span>
    <span class="token comment">// to Seek(key).  May not make such a call if filter policy says</span>
    <span class="token comment">// that key is not present.</span>
    Status <span class="token function">InternalGet</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions <span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
                       <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>handle_result<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>k<span class="token punctuation">,</span>
                                             <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取Meta Block和Filter Block</span>
    <span class="token keyword">void</span> <span class="token function">ReadMeta</span><span class="token punctuation">(</span><span class="token keyword">const</span> Footer <span class="token operator">&amp;</span>footer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">ReadFilter</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>filter_handle_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Rep <span class="token operator">*</span><span class="token keyword">const</span> rep_<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// Attempt to open the table that is stored in bytes [0..file_size)</span>
    <span class="token comment">// of "file", and read the metadata entries necessary to allow</span>
    <span class="token comment">// retrieving data from the table.</span>
    <span class="token comment">//</span>
    <span class="token comment">// If successful, returns ok and sets "*table" to the newly opened</span>
    <span class="token comment">// table.  The client should delete "*table" when no longer needed.</span>
    <span class="token comment">// If there was an error while initializing the table, sets "*table"</span>
    <span class="token comment">// to nullptr and returns a non-ok status.  Does not take ownership of</span>
    <span class="token comment">// "*source", but the client must ensure that "source" remains live</span>
    <span class="token comment">// for the duration of the returned table's lifetime.</span>
    <span class="token comment">//</span>
    <span class="token comment">// *file must remain live while this Table is in use.</span>

    <span class="token comment">// 打开一个可以随机读取的SSTable文件，并返回从这个文件中读取的Table类</span>
    <span class="token comment">// RandomAccessFile可以看成是一个随机读写迭代器</span>
    <span class="token comment">// 这里的原文我保留下来，写的很详细</span>
    <span class="token keyword">static</span> Status <span class="token function">Open</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">&amp;</span>options<span class="token punctuation">,</span> RandomAccessFile <span class="token operator">*</span>file<span class="token punctuation">,</span>
                       <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">,</span> Table <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造析构函数相关</span>
    <span class="token function">Table</span><span class="token punctuation">(</span><span class="token keyword">const</span> Table <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    Table <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Table <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回一个指向Table内的数据的迭代器，初始生成的迭代器不可用，需要手动初始化</span>
    Iterator <span class="token operator">*</span><span class="token function">NewIterator</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token comment">// 用于估算key值所在记录的偏移，目前作用不是很清楚</span>
    <span class="token keyword">uint64_t</span> <span class="token function">ApproximateOffsetOf</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>key<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>头文件中定义了缓存用的友元类、迭代器这些，说明Table类其实也没有定义怎么构建SSTable，而主要的目的是从文件中读取一个SSTable出来。</p>
<p>由于这其中涉及到了迭代器和缓存类，所以具体的实现我们就先略过，等到后面再详细看。</p>
<h3 id="table的构建--tablebuilder">Table的构建--TableBuilder</h3>
<p>Block的构建是通过BlockBuilder类来完成的，而Table的构建则是通过TableBuilder类来完成的。我们先来看一下其头文件</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token keyword">class</span> <span class="token class-name">LEVELDB_EXPORT</span> TableBuilder
<span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 返回构建器状态</span>
    <span class="token keyword">bool</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// 写入Block的封装函数，对WriteRawBlock的封装</span>
    <span class="token keyword">void</span> <span class="token function">WriteBlock</span><span class="token punctuation">(</span>BlockBuilder <span class="token operator">*</span>block<span class="token punctuation">,</span> BlockHandle <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将Block实际写入文件的函数，包含压缩类型</span>
    <span class="token keyword">void</span> <span class="token function">WriteRawBlock</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> CompressionType<span class="token punctuation">,</span> BlockHandle <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">Rep</span><span class="token punctuation">;</span> <span class="token comment">// 这个Rep与Table类中的Rep不一样，其声明位置是不同的</span>
    Rep <span class="token operator">*</span>rep_<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 创建一个Builder类来完成文件的写入</span>
    <span class="token function">TableBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">&amp;</span>options<span class="token punctuation">,</span> WritableFile <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TableBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> TableBuilder <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    TableBuilder <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> TableBuilder <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">TableBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 改变Builder类的Options，只有部分选项可以被更改</span>
    Status <span class="token function">ChangeOptions</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">&amp;</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加一个key-value需要保证key比之前的都大</span>
    <span class="token keyword">void</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 这个函数的作用是把缓存区中的key-value持久化到磁盘中</span>
    <span class="token keyword">void</span> <span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回构建器的状态</span>
    Status <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token comment">// 结束当前构建，和BlockTable中一样</span>
    Status <span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 抛弃掉当前构建器</span>
    <span class="token keyword">void</span> <span class="token function">Abandon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add的次数</span>
    <span class="token keyword">uint64_t</span> <span class="token function">NumEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回构建的文件大小</span>
    <span class="token keyword">uint64_t</span> <span class="token function">FileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到TableBuilder的头文件中定义了将Key写入文件的部分。以及，虽然这个类中也存在一个类型为Req的东西，但是和Table类中的不是同一个东西，我们看一下其定义。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token keyword">struct</span> <span class="token class-name">TableBuilder</span><span class="token operator">:</span><span class="token base-clause"><span class="token operator">:</span><span class="token class-name">Rep</span></span>
<span class="token punctuation">{</span>
    <span class="token function">Rep</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">&amp;</span>opt<span class="token punctuation">,</span> WritableFile <span class="token operator">*</span>f<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">options</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">index_block_options</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">file</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">data_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">index_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>index_block_options<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">num_entries</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">closed</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">filter_block</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>filter_policy <span class="token operator">==</span> <span class="token keyword">nullptr</span>
                           <span class="token operator">?</span> <span class="token keyword">nullptr</span>
                           <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token function">FilterBlockBuilder</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>filter_policy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">pending_index_entry</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        index_block_options<span class="token punctuation">.</span>block_restart_interval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Options options<span class="token punctuation">;</span>                  <span class="token comment">// 选项</span>
    Options index_block_options<span class="token punctuation">;</span>      <span class="token comment">// index_block的选项</span>
    WritableFile <span class="token operator">*</span>file<span class="token punctuation">;</span>               <span class="token comment">// 写入的文件</span>
    <span class="token keyword">uint64_t</span> offset<span class="token punctuation">;</span>                  <span class="token comment">// 偏移值</span>
    Status status<span class="token punctuation">;</span>                    <span class="token comment">// 状态</span>
    BlockBuilder data_block<span class="token punctuation">;</span>          <span class="token comment">// data_block构建器</span>
    BlockBuilder index_block<span class="token punctuation">;</span>         <span class="token comment">// index_block构建器</span>
    std<span class="token double-colon punctuation">::</span>string last_key<span class="token punctuation">;</span>             <span class="token comment">// 上一个写入的key</span>
    <span class="token keyword">int64_t</span> num_entries<span class="token punctuation">;</span>              <span class="token comment">// 写入的key次数</span>
    <span class="token keyword">bool</span> closed<span class="token punctuation">;</span>                      <span class="token comment">// Table构建器是否关闭</span>
    FilterBlockBuilder <span class="token operator">*</span>filter_block<span class="token punctuation">;</span> <span class="token comment">// 过滤器block</span>

    <span class="token comment">// We do not emit the index entry for a block until we have seen the</span>
    <span class="token comment">// first key for the next data block.  This allows us to use shorter</span>
    <span class="token comment">// keys in the index block.  For example, consider a block boundary</span>
    <span class="token comment">// between the keys "the quick brown fox" and "the who".  We can use</span>
    <span class="token comment">// "the r" as the key for the index block entry since it is &gt;= all</span>
    <span class="token comment">// entries in the first block and &lt; all entries in subsequent</span>
    <span class="token comment">// blocks.</span>
    <span class="token comment">// 这里的原注释可以好好看一下</span>
    <span class="token comment">// Invariant: r-&gt;pending_index_entry is true only if data_block is empty.</span>
    <span class="token keyword">bool</span> pending_index_entry<span class="token punctuation">;</span>   <span class="token comment">// 当data_block为空时是true否则为false</span>
    BlockHandle pending_handle<span class="token punctuation">;</span> <span class="token comment">// 是一个为index_block添加数据时使用的handler</span>

    std<span class="token double-colon punctuation">::</span>string compressed_output<span class="token punctuation">;</span> <span class="token comment">// 压缩输出</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个结构体中定义了table中包含的各个部分，这些部分没有直接在Table类中定义，是因为那样就会让Table类十分冗长，使用类内的一个结构体会清晰很多。实际上，TableBuilder类在进行构建的时候也是直接处理这个结构体的。</p>
<p>下面我们来看一下TableBuiler类的具体实现。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">
<span class="token comment">// 构造函数</span>
<span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">TableBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">&amp;</span>options<span class="token punctuation">,</span> WritableFile <span class="token operator">*</span>file<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">rep_</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Rep</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rep_<span class="token operator">-&gt;</span>filter_block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        rep_<span class="token operator">-&gt;</span>filter_block<span class="token operator">-&gt;</span><span class="token function">StartBlock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 析构函数</span>
<span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">TableBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>rep_<span class="token operator">-&gt;</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Catch errors where caller forgot to call Finish()</span>
    <span class="token keyword">delete</span> rep_<span class="token operator">-&gt;</span>filter_block<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> rep_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 改变TableBudiler类的选项</span>
Status <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">ChangeOptions</span><span class="token punctuation">(</span><span class="token keyword">const</span> Options <span class="token operator">&amp;</span>options<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>comparator <span class="token operator">!=</span> rep_<span class="token operator">-&gt;</span>options<span class="token punctuation">.</span>comparator<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">InvalidArgument</span><span class="token punctuation">(</span><span class="token string">"changing comparator while building table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    rep_<span class="token operator">-&gt;</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    rep_<span class="token operator">-&gt;</span>index_block_options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    rep_<span class="token operator">-&gt;</span>index_block_options<span class="token punctuation">.</span>block_restart_interval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 添加一个key-value</span>
<span class="token keyword">void</span> <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Rep <span class="token operator">*</span>r <span class="token operator">=</span> rep_<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token operator">-&gt;</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果之前有添加过，则需要保证现在的key比之前的key要大</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>num_entries <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>options<span class="token punctuation">.</span>comparator<span class="token operator">-&gt;</span><span class="token function">Compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">Slice</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>last_key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// pending_index_entry当data_block为空时是true，其实就是标识出重启点</span>
    <span class="token comment">// 目的是把block加入index中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>pending_index_entry<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>data_block<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 压缩一下key长度，这个压缩与重启点的压缩其实不冲突</span>
        r<span class="token operator">-&gt;</span>options<span class="token punctuation">.</span>comparator<span class="token operator">-&gt;</span><span class="token function">FindShortestSeparator</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>last_key<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string handle_encoding<span class="token punctuation">;</span>
        r<span class="token operator">-&gt;</span>pending_handle<span class="token punctuation">.</span><span class="token function">EncodeTo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle_encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把block中的起始位置和偏移编码后存入index，因为每个重启点处相当于datablock起点</span>
        r<span class="token operator">-&gt;</span>index_block<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>last_key<span class="token punctuation">,</span> <span class="token function">Slice</span><span class="token punctuation">(</span>handle_encoding<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token operator">-&gt;</span>pending_index_entry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>filter_block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        r<span class="token operator">-&gt;</span>filter_block<span class="token operator">-&gt;</span><span class="token function">AddKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 更新一下参数并把key-value加入到data_block中</span>
    r<span class="token operator">-&gt;</span>last_key<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>num_entries<span class="token operator">++</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>data_block<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果目前缓冲区数据长度比较长就持久化到文件</span>
    <span class="token keyword">const</span> size_t estimated_block_size <span class="token operator">=</span> r<span class="token operator">-&gt;</span>data_block<span class="token punctuation">.</span><span class="token function">CurrentSizeEstimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>estimated_block_size <span class="token operator">&gt;=</span> r<span class="token operator">-&gt;</span>options<span class="token punctuation">.</span>block_size<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 持久化到文件</span>
<span class="token keyword">void</span> <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Rep <span class="token operator">*</span>r <span class="token operator">=</span> rep_<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token operator">-&gt;</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>data_block<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token operator">-&gt;</span>pending_index_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WriteBlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>data_block<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>pending_handle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用TableBuilder写入文件的函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        r<span class="token operator">-&gt;</span>pending_index_entry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        r<span class="token operator">-&gt;</span>status <span class="token operator">=</span> r<span class="token operator">-&gt;</span>file<span class="token operator">-&gt;</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用文件的持久化函数</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>filter_block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        r<span class="token operator">-&gt;</span>filter_block<span class="token operator">-&gt;</span><span class="token function">StartBlock</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 布隆过滤器</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 把Table中的Block写入文件，只是这个函数是一层封装，内部只执行了压缩步骤</span>
<span class="token keyword">void</span> <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">WriteBlock</span><span class="token punctuation">(</span>BlockBuilder <span class="token operator">*</span>block<span class="token punctuation">,</span> BlockHandle <span class="token operator">*</span>handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 写入文件的格式block_data, type, crc</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Rep <span class="token operator">*</span>r <span class="token operator">=</span> rep_<span class="token punctuation">;</span>
    Slice raw <span class="token operator">=</span> block<span class="token operator">-&gt;</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拿出Block的数据</span>

    Slice block_contents<span class="token punctuation">;</span>
    CompressionType type <span class="token operator">=</span> r<span class="token operator">-&gt;</span>options<span class="token punctuation">.</span>compression<span class="token punctuation">;</span> <span class="token comment">// 压缩类型</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span>                                  <span class="token comment">// 根据压缩类型来执行压缩</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> kNoCompression<span class="token operator">:</span> <span class="token comment">// 不压缩</span>
        block_contents <span class="token operator">=</span> raw<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> kSnappyCompression<span class="token operator">:</span> <span class="token comment">// Snappy压缩</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>string <span class="token operator">*</span>compressed <span class="token operator">=</span> <span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>compressed_output<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>port<span class="token double-colon punctuation">::</span><span class="token function">Snappy_Compress</span><span class="token punctuation">(</span>raw<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compressed<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            compressed<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> raw<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>raw<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            block_contents <span class="token operator">=</span> <span class="token operator">*</span>compressed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Snappy not supported, or compressed less than 12.5%, so just</span>
            <span class="token comment">// store uncompressed form</span>
            block_contents <span class="token operator">=</span> raw<span class="token punctuation">;</span>
            type <span class="token operator">=</span> kNoCompression<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用WriteRawBlock来真正写入文件中</span>
    <span class="token function">WriteRawBlock</span><span class="token punctuation">(</span>block_contents<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>compressed_output<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    block<span class="token operator">-&gt;</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 写入文件的函数</span>
<span class="token keyword">void</span> <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">WriteRawBlock</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice <span class="token operator">&amp;</span>block_contents<span class="token punctuation">,</span>
                                 CompressionType type<span class="token punctuation">,</span> BlockHandle <span class="token operator">*</span>handle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Rep <span class="token operator">*</span>r <span class="token operator">=</span> rep_<span class="token punctuation">;</span>
    handle<span class="token operator">-&gt;</span><span class="token function">set_offset</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    handle<span class="token operator">-&gt;</span><span class="token function">set_size</span><span class="token punctuation">(</span>block_contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>status <span class="token operator">=</span> r<span class="token operator">-&gt;</span>file<span class="token operator">-&gt;</span><span class="token function">Append</span><span class="token punctuation">(</span>block_contents<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用文件写入的函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">char</span> trailer<span class="token punctuation">[</span>kBlockTrailerSize<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// block的尾部由压缩类型与crc组成</span>
        trailer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">uint32_t</span> crc <span class="token operator">=</span> crc32c<span class="token double-colon punctuation">::</span><span class="token function">Value</span><span class="token punctuation">(</span>block_contents<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block_contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        crc <span class="token operator">=</span> crc32c<span class="token double-colon punctuation">::</span><span class="token function">Extend</span><span class="token punctuation">(</span>crc<span class="token punctuation">,</span> trailer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Extend crc to cover block type</span>
        <span class="token function">EncodeFixed32</span><span class="token punctuation">(</span>trailer <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> crc32c<span class="token double-colon punctuation">::</span><span class="token function">Mask</span><span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 然后把尾部添加进文件中</span>
        r<span class="token operator">-&gt;</span>status <span class="token operator">=</span> r<span class="token operator">-&gt;</span>file<span class="token operator">-&gt;</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token function">Slice</span><span class="token punctuation">(</span>trailer<span class="token punctuation">,</span> kBlockTrailerSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            r<span class="token operator">-&gt;</span>offset <span class="token operator">+=</span> block_contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> kBlockTrailerSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回状态</span>
Status <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rep_<span class="token operator">-&gt;</span>status<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 结束构建</span>
Status <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Rep <span class="token operator">*</span>r <span class="token operator">=</span> rep_<span class="token punctuation">;</span>
    <span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token operator">-&gt;</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    BlockHandle filter_block_handle<span class="token punctuation">,</span> metaindex_block_handle<span class="token punctuation">,</span> index_block_handle<span class="token punctuation">;</span>

    <span class="token comment">// 写入filter_block</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r<span class="token operator">-&gt;</span>filter_block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">WriteRawBlock</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>filter_block<span class="token operator">-&gt;</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kNoCompression<span class="token punctuation">,</span>
                      <span class="token operator">&amp;</span>filter_block_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入metaindex_block</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        BlockBuilder <span class="token function">meta_index_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>filter_block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token double-colon punctuation">::</span>string key <span class="token operator">=</span> <span class="token string">"filter."</span><span class="token punctuation">;</span>
            key<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>options<span class="token punctuation">.</span>filter_policy<span class="token operator">-&gt;</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>string handle_encoding<span class="token punctuation">;</span>
            filter_block_handle<span class="token punctuation">.</span><span class="token function">EncodeTo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle_encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
            meta_index_block<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> handle_encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">WriteBlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>meta_index_block<span class="token punctuation">,</span> <span class="token operator">&amp;</span>metaindex_block_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入index_block</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>pending_index_entry<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            r<span class="token operator">-&gt;</span>options<span class="token punctuation">.</span>comparator<span class="token operator">-&gt;</span><span class="token function">FindShortSuccessor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>last_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>string handle_encoding<span class="token punctuation">;</span>
            r<span class="token operator">-&gt;</span>pending_handle<span class="token punctuation">.</span><span class="token function">EncodeTo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle_encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token operator">-&gt;</span>index_block<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>last_key<span class="token punctuation">,</span> <span class="token function">Slice</span><span class="token punctuation">(</span>handle_encoding<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token operator">-&gt;</span>pending_index_entry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">WriteBlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>r<span class="token operator">-&gt;</span>index_block<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index_block_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入table的Footer</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Footer footer<span class="token punctuation">;</span>
        footer<span class="token punctuation">.</span><span class="token function">set_metaindex_handle</span><span class="token punctuation">(</span>metaindex_block_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        footer<span class="token punctuation">.</span><span class="token function">set_index_handle</span><span class="token punctuation">(</span>index_block_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string footer_encoding<span class="token punctuation">;</span>
        footer<span class="token punctuation">.</span><span class="token function">EncodeTo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>footer_encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token operator">-&gt;</span>status <span class="token operator">=</span> r<span class="token operator">-&gt;</span>file<span class="token operator">-&gt;</span><span class="token function">Append</span><span class="token punctuation">(</span>footer_encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">-&gt;</span>status<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            r<span class="token operator">-&gt;</span>offset <span class="token operator">+=</span> footer_encoding<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> r<span class="token operator">-&gt;</span>status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 放弃构建</span>
<span class="token keyword">void</span> <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Abandon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Rep <span class="token operator">*</span>r <span class="token operator">=</span> rep_<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token operator">-&gt;</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token operator">-&gt;</span>closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Add的次数</span>
<span class="token keyword">uint64_t</span> <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">NumEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rep_<span class="token operator">-&gt;</span>num_entries<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">// 文件的大小</span>
<span class="token keyword">uint64_t</span> <span class="token class-name">TableBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">FileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rep_<span class="token operator">-&gt;</span>offset<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过这个TableBuilder类，我们就可以很清晰地看出一个Table是怎么构建的了。下面给出构建一个Table的流程。</p>
<ul>
<li>TableBuilder类首先在类内创建出各类BlockBuilder，包括dataBlock，metadataBlock，filterBlock等等。</li>
<li>然后当每次需要插入一个key时就会调用TableBuilder的add方法，这个方法会自动负责处理index_block、重启点、filter_block以及对每个key进行长度压缩(这个压缩不是共享key，而是调用comparator中的FindShortestSeparator方法)。另外TableBuilder类插入key-value会首先写入内存中，只有当内存部分的大小超过一定长度才会写持久化到硬盘。</li>
<li>Flush函数负责将目前的数据区追加写到磁盘中，它会调用WriteBlock函数，注意Flush不会把非data_block的block持久化。</li>
<li>WriteBlock函数是对WriteRawBlock函数的封装。它主要是处理了数据压缩的部分，然后把压缩后的数据和压缩类型以及数据的crc校验码传递给WriteRawBlock函数。</li>
<li>WriteRawBlock函数是真正写入数据的函数，每个Block都由数据区和偏置区、压缩类型以及crc校验组成。</li>
<li>当一个table完成构建时就会调用finish函数，这个函数会负责追加写filter_block、metaindex_block、index_block和Footer。其中写入每个Block时会调用对应handler的encode函数来将每个block编码成字符串。</li>
</ul>
<p>我们继续来审视一下SSTable和Block的结构图，这样我们会更加清楚其结构。</p>
<img src="/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/pic1.jpg" class="">
<img src="/2022/09/27/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-8/pic2.jpg" class="">
<h2 id="总结">总结</h2>
<p>不得不说，Block的统一的设计还是非常的巧妙，所有的Block结构都是一样的，只是提供了统一的接口(Add)，内部设计包含了key的前缀压缩、偏置区、重启点等等优化设计。而filterBlock和IndexBlock等等也是包含这些偏置区和重启点的，可能会感觉有些奇怪，因为这些存储的都是过滤器或者是索引。但是由于我们不需要关心这些内部的细节，所以可以看成是数据结构内部优化即可。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/levelDB/" rel="tag"># levelDB</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/09/23/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-7/" rel="prev" title="levelDB源码剖析(7)--SSTable结构">
      <i class="fa fa-chevron-left"></i> levelDB源码剖析(7)--SSTable结构
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/29/levelDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-9/" rel="next" title="levelDB源码剖析(9)--WAL日志">
      levelDB源码剖析(9)--WAL日志 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#block%E5%92%8Csstable%E7%9A%84%E6%9E%84%E5%BB%BA"><span class="nav-number">1.</span> <span class="nav-text">Block和SSTable的构建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#block%E7%9A%84%E6%9E%84%E5%BB%BA--blockbuilder"><span class="nav-number">1.1.</span> <span class="nav-text">Block的构建--BlockBuilder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#table%E7%B1%BB"><span class="nav-number">1.2.</span> <span class="nav-text">Table类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#table%E7%9A%84%E6%9E%84%E5%BB%BA--tablebuilder"><span class="nav-number">1.3.</span> <span class="nav-text">Table的构建--TableBuilder</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Staskaer"
      src="/imgs/theme_pic/head_img.png">
  <p class="site-author-name" itemprop="name">Staskaer</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Staskaer" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Staskaer" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liujiaxin011121@gmail.com" title="E-Mail → mailto:liujiaxin011121@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Staskaer</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'xH8NDrh9u4SQrUpQOd0lICnX-MdYXbMMI',
      appKey     : 'jl3JjPS4jsosZG29Zv24Y7LE',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-Hans' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>

